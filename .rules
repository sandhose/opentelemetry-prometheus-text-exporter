# OpenTelemetry Prometheus Exporter Project Rules

## Project Overview
- **Name**: `opentelemetry-prometheus-exporter`
- **Purpose**: Converts OpenTelemetry metrics to Prometheus text exposition format
- **Language**: Rust

## Development Workflow

### 1. Code Changes Process
1. **First Priority**: Get code compiling
   ```bash
   cargo check
   ```

2. **Second Priority**: Fix clippy issues
   ```bash
   cargo clippy --tests
   ```

3. **Code Formatting**: Format code regularly
   ```bash
   cargo +nightly fmt
   ```

4. **Testing**: Run tests with snapshot testing
   ```bash
   cargo insta test
   cargo insta pending-snapshots  # Review changes if necessary
   cargo insta accept            # Accept snapshots if correct
   ```

### 2. Testing Guidelines

#### Snapshot Testing with Insta
- **Use snapshots when possible** for testing output format
- **Workflow**:
  1. `cargo insta test` - Run tests and generate/compare snapshots
  2. `cargo insta pending-snapshots` - Review pending snapshot changes
  3. `cargo insta accept` - Accept new/changed snapshots if correct
- **Best for**: Prometheus text format output, configuration examples

#### Test Structure
- **Unit tests**: In `src/serialize.rs` and `src/exporter.rs` - test individual functions
- **Integration tests**: In `tests/it/main.rs` - test complete export workflow
- **Doc tests**: In lib.rs and module docs - test documentation examples

#### Test Coverage Areas
- All configuration options (`without_units`, `without_counter_suffixes`, etc.)
- Memory optimization (Cow<str> usage)
- Edge cases (empty resources, invalid names, special values)
- Prometheus format compliance

### 3. Code Quality

#### Clippy Configuration
- **Pedantic rules enabled** by default in `src/lib.rs`
- **If clippy rule is annoying**: Discuss with team, okay to add exceptions
- **Current exceptions**: Check `src/lib.rs` for `#[allow(...)]` attributes
- **Zero tolerance**: All clippy warnings must be fixed before merge

#### Code Standards
- **Memory optimization**: Use `Cow<str>` for avoiding unnecessary allocations
- **Error handling**: Proper error propagation and informative messages
- **Documentation**: All public APIs must have comprehensive docs with examples

### 4. API Design Guidelines

#### Configuration Options
- **Builder pattern**: Use `ExporterBuilder` for all configuration
- **Compatibility**: Maintain API compatibility with `opentelemetry-prometheus` crate
- **Method naming**: Follow established patterns (`without_*` for disabling features)

#### Supported Configuration
- `without_units()` - Disable unit suffixes in metric names
- `without_counter_suffixes()` - Disable `_total` suffixes on counters
- `without_target_info()` - Disable resource `target_info` metric
- `without_scope_info()` - Disable OpenTelemetry scope labels

#### NOT Implemented (Excluded)
- `with_registry()` - Registry management
- `with_resource_selector()` - Resource filtering
- `with_namespace()` - Metric name prefixing

### 5. Performance Requirements

#### Memory Optimization
- **Cow<str> usage**: Avoid allocations when possible
- **Lazy processing**: Only transform when necessary
- **Examples**:
  - Valid names: `Cow::Borrowed` (no allocation)
  - Invalid names: `Cow::Owned` (allocation only when needed)

#### Streaming
- **Direct writing**: Write to provided writer without intermediate buffering
- **Single-pass**: Process metrics in one iteration

### 6. Benchmarking

#### Benchmark Suite
- **Location**: `benches/serialize.rs`
- **Focus**: Counter metrics (most common type in production)
- **Methodology**: Uses fake writer (`DevNull`) to isolate serialization performance

#### Benchmark Categories
- **Metrics Count**: Scaling with number of different metrics (1-100)
- **Cardinality**: Scaling with label combinations per metric (1-250)
- **Total Time Series**: Scaling with metrics × cardinality (100-10,000 time series)
- **Configurations**: Performance impact of different exporter options
- **Realistic Scenarios**: Real-world workload patterns
- **Memory Patterns**: `Cow<str>` optimization effectiveness
- **Implementation Comparison**: Performance vs existing opentelemetry-prometheus crate

#### Running Benchmarks
```bash
# Quick feedback (reduced sample size)
cargo bench --bench serialize -- --quick

# Full benchmark suite
cargo bench --bench serialize

# Implementation comparison
cargo bench --bench comparison

# Specific benchmark groups
cargo bench --bench serialize -- metrics_count
cargo bench --bench serialize -- cardinality
cargo bench --bench serialize -- total_time_series
cargo bench --bench serialize -- configurations

# Comparison benchmark groups
cargo bench --bench comparison -- implementation_comparison
cargo bench --bench comparison -- scaling_comparison
```

#### Performance Expectations
- **Linear scaling** with both metric count and cardinality
- **Consistent throughput** of ~2.0-2.5 million time series per second
- **Minimal configuration overhead** (< 5% difference between options)
- **Memory optimization benefits** for clean metric names
- **Production performance**: Small services < 100µs, large services < 10ms

#### Parametric Benchmarking Features
- **Automatic scaling plots**: Line charts showing performance vs input parameters
- **Throughput measurements**: Time series per second for easy comparison
- **Statistical analysis**: Regression analysis and confidence intervals
- **Benchmark groups**: Related benchmarks plotted together for comparison

#### Comparison Benchmark
- **Purpose**: Compare performance against existing opentelemetry-prometheus crate
- **Results**: New implementation is ~2.5-3x faster time series processing with identical output format
- **Compatibility**: Validates format compatibility and migration safety
- **Location**: `benches/comparison.rs` with detailed documentation

#### Extending Benchmarks
- Create new setup functions for different metric types (histograms, gauges)
- Add realistic label patterns for your use case
- Follow existing patterns for proper provider lifetime management

### 7. Prometheus Compliance

#### Metric Type Support
- ✅ **Gauges**: All numeric types → Prometheus Gauge
- ✅ **Sums**: Cumulative+Monotonic → Counter, Cumulative+Non-monotonic → Gauge
- ✅ **Histograms**: All numeric types → Prometheus Histogram family
- ❌ **Exponential histograms**: Currently skipped, unsupported by Prometheus

#### Name & Unit Transformations
- **Sanitization**: Invalid chars → `_`, collapse multiple `_`
- **Units**: Remove brackets, expand abbreviations, special cases
- **Suffixes**: Auto unit suffixes, `_total` for monotonic sums

#### Output Format
- **Comments**: TYPE, HELP (with escaping), UNIT
- **Values**: Proper NaN, ±Inf handling for f64
- **Text Format**: Valid Prometheus exposition format

### 8. Development Commands

```bash
# Development cycle
cargo check                    # Compile check
cargo clippy --tests         # Lint check
cargo +nightly fmt           # Format code
cargo test                   # Run all tests
cargo insta test            # Run with snapshot testing

# Snapshot workflow
cargo insta pending-snapshots  # Review changes
cargo insta accept             # Accept changes

# Full validation
cargo test --all-targets      # All tests
cargo clippy --tests         # All lint checks
```

### 9. File Structure

```
src/
├── lib.rs          # Public API and documentation
├── exporter.rs     # PrometheusExporter + ExporterBuilder
└── serialize.rs    # Core conversion logic (PrometheusSerializer)
tests/
└── it/main.rs      # Integration tests with snapshot testing
benches/
├── serialize.rs    # Performance benchmarks with criterion
└── comparison.rs   # Implementation comparison benchmarks
.rustfmt.toml         # Rustfmt configuration
.rules                # Rules for LLMs
Cargo.toml            # Project manifest
```

### 10. Contribution Guidelines

- **Breaking changes**: Discuss first, maintain backward compatibility
- **New features**: Add comprehensive tests and documentation
- **Bug fixes**: Include regression test
- **Documentation**: Update examples when changing APIs
- **Performance**: Maintain memory optimization patterns

### 11. Dependencies

- `opentelemetry` (metrics feature only)
- `opentelemetry_sdk` (metrics + experimental_metrics_custom_reader)
- `smartstring` (for avoiding allocations when possible)
- `insta` (dev dependency for snapshot testing)
- `criterion` 0.5 (dev dependency for performance benchmarking)
- `prometheus` 0.14 (dev dependency for comparison benchmarks)
- `opentelemetry-prometheus` (dev dependency for comparison benchmarks)
